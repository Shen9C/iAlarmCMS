{% extends "base.html" %}

{% block title %}边缘设备管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">边缘设备管理</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                            <i class="fas fa-plus"></i> 添加设备
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped" id="deviceTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>设备编号</th>  <!-- 新增设备编号列 -->
                                <th>设备名称</th>
                                <th>IP地址</th>
                                <th>访问密钥</th>
                                <th>密钥</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in devices %}
                            <tr>
                                <td>{{ device.id }}</td>
                                <td>{{ device.device_id }}</td>  <!-- 显示设备编号 -->
                                <td>{{ device.device_name }}</td>
                                <td>{{ device.ip_address }}</td>
                                <td>
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-sm" value="{{ device.access_key }}" readonly>
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary btn-sm copy-btn" data-clipboard-text="{{ device.access_key }}" type="button">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group">
                                        <input type="password" class="form-control form-control-sm secret-key" value="{{ device.secret_key }}" readonly>
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary btn-sm toggle-password" type="button">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm copy-btn" data-clipboard-text="{{ device.secret_key }}" type="button">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ device.created_at }}</td>
                                <td>
                                    <button class="btn btn-info btn-sm edit-device" data-id="{{ device.id }}" data-name="{{ device.device_name }}" data-ip="{{ device.ip_address }}" data-device-id="{{ device.device_id }}">
                                        <i class="fas fa-edit"></i> 编辑
                                    </button>
                                    <button class="btn btn-warning btn-sm regenerate-keys" data-id="{{ device.id }}">
                                        <i class="fas fa-key"></i> 重新生成密钥
                                    </button>
                                    <button class="btn btn-danger btn-sm delete-device" data-id="{{ device.id }}" data-name="{{ device.device_name }}">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加设备模态框 -->
<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-labelledby="addDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDeviceModalLabel">添加边缘设备</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDeviceForm">
                    <div class="form-group mb-3">
                        <label for="deviceId" class="form-label">设备编号</label>
                        <input type="text" class="form-control" id="deviceId" name="device_id">
                        <small class="form-text text-muted">设备的唯一标识符，不输入则自动生成</small>
                    </div>
                    <div class="form-group mb-3">
                        <label for="deviceName" class="form-label">设备名称</label>
                        <input type="text" class="form-control" id="deviceName" name="device_name" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="deviceIp" class="form-label">IP地址</label>
                        <input type="text" class="form-control" id="deviceIp" name="ip_address" required pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                        <small class="form-text text-muted">请输入有效的IPv4地址，例如：192.168.1.1</small>
                    </div>
                </form>
            </div>
            <!-- 在模态框底部添加测试按钮 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info" id="testApiBtn">测试API</button>
                <button type="button" class="btn btn-primary" id="saveDeviceBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑设备模态框 -->
<div class="modal fade" id="editDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDeviceModalLabel">编辑边缘设备</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editDeviceForm">
                    <input type="hidden" id="editDeviceId">
                    <div class="form-group mb-3">
                        <label for="editDeviceIdField" class="form-label">设备编号</label>
                        <input type="text" class="form-control" id="editDeviceIdField">
                        <small class="form-text text-muted">设备的唯一标识符</small>
                    </div>
                    <div class="form-group mb-3">
                        <label for="editDeviceName" class="form-label">设备名称</label>
                        <input type="text" class="form-control" id="editDeviceName" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="editDeviceIp" class="form-label">IP地址</label>
                        <input type="text" class="form-control" id="editDeviceIp" required pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                        <small class="form-text text-muted">请输入有效的IPv4地址，例如：192.168.1.1</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateDeviceBtn">更新</button>
            </div>
        </div>
    </div>
</div>

<!-- 确认删除模态框 -->
<div class="modal fade" id="deleteDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteDeviceModalLabel">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除设备 <span id="deleteDeviceName" class="font-weight-bold"></span> 吗？此操作不可逆。</p>
                <input type="hidden" id="deleteDeviceId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 确认重新生成密钥模态框 -->
<div class="modal fade" id="regenerateKeysModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="regenerateKeysModalLabel">确认重新生成密钥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要为此设备重新生成访问密钥(AK)和密钥(SK)吗？</p>
                <p class="text-danger">注意：重新生成后，使用旧密钥的设备将无法连接，需要更新配置。</p>
                <input type="hidden" id="regenerateDeviceId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" id="confirmRegenerateBtn">确认重新生成</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
<!-- 添加Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
/* 完全移除模态框遮罩层 */
.modal-backdrop {
    display: none !important;
}

/* 调整模态框样式 */
.modal-dialog {
    z-index: 2056 !important; /* 提高z-index确保在最上层 */
    margin: 8rem auto !important; /* 调整位置 */
}

/* 确保模态框内容可交互 */
.modal-content {
    box-shadow: 0 5px 15px rgba(0,0,0,.5) !important; /* 添加阴影增强视觉效果 */
}

/* 防止页面锁定 */
body.modal-open {
    overflow: auto !important;
    padding-right: 0 !important;
}

/* 确保输入框可编辑 */
.modal input, .modal textarea, .modal select {
    pointer-events: auto !important;
    background-color: #fff !important;
    opacity: 1 !important;
}

/* 确保按钮可点击 */
.modal button {
    pointer-events: auto !important;
}
</style>
{% endblock %}

{% block scripts %}
<!-- 添加Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script>
<script>
console.log('脚本开始加载...');
console.log('jQuery版本:', typeof $ !== 'undefined' ? $.fn.jquery : '未加载');
console.log('Bootstrap对象:', typeof bootstrap !== 'undefined' ? '已加载' : '未加载');

// 检查模态框相关方法是否存在
if (typeof bootstrap !== 'undefined') {
    console.log('Bootstrap.Modal是否存在:', typeof bootstrap.Modal !== 'undefined');
}

// 直接添加调试代码，不等待文档加载
console.log('添加设备按钮元素:', document.getElementById('addDeviceBtn'));
console.log('添加设备模态框元素:', document.getElementById('addDeviceModal'));

// 检查添加设备模态框的内容
var modalEl = document.getElementById('addDeviceModal');
if (modalEl) {
    console.log('模态框HTML:', modalEl.outerHTML);
}

$(document).ready(function() {
    console.log('文档加载完成');
    
    // 检查base.html是否已经加载了Bootstrap 5
    console.log('页面上是否有Bootstrap 5的CSS:', $('link[href*="bootstrap@5"]').length > 0);
    console.log('页面上是否有Bootstrap 5的JS:', $('script[src*="bootstrap@5"]').length > 0);
    
    // 手动初始化所有模态框
    var modals = document.querySelectorAll('.modal');
    modals.forEach(function(modalEl) {
        var modal = new bootstrap.Modal(modalEl, {
            backdrop: false, // 禁用backdrop
            keyboard: true
        });
        
        // 存储modal实例到DOM元素
        modalEl._bsModal = modal;
    });
    
    // 添加设备按钮点击事件 - 手动触发模态框
    $('#addDeviceBtn').on('click', function() {
        console.log('点击添加设备按钮');
        var modalEl = document.getElementById('addDeviceModal');
        if (modalEl && modalEl._bsModal) {
            modalEl._bsModal.show();
        } else {
            // 如果没有存储实例，创建新实例
            var modal = new bootstrap.Modal(modalEl, {
                backdrop: false,
                keyboard: true
            });
            modal.show();
        }
        
        // 确保输入框可编辑
        setTimeout(function() {
            $('#deviceName').prop('disabled', false).focus();
            $('#deviceIp').prop('disabled', false);
        }, 500);
    });
    
    // 添加测试API按钮的事件处理
    $('#testApiBtn').click(function() {
        console.log('测试API按钮点击');
        
        // 发送一个简单的测试请求
        fetch('/api/edge_devices/test', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('测试API响应状态:', response.status);
            return response.text();
        })
        .then(text => {
            console.log('测试API响应内容:', text);
            alert('API测试结果已在控制台显示');
        })
        .catch(error => {
            console.error('测试API错误:', error);
            alert('API测试失败: ' + error.message);
        });
    });
    
    // 修改前端AJAX请求代码：
    $('#saveDeviceBtn').click(function() {
        console.log('点击保存按钮');
        var device_id = $('#deviceId').val();
        var name = $('#deviceName').val();
        var ip = $('#deviceIp').val();
        
        console.log('表单数据:', {
            device_id: device_id,
            device_name: name,
            ip_address: ip
        });
    
        if (!name || !ip) {
            console.log('表单验证失败：字段为空');
            toastr.error('请填写所有必填字段');
            return;
        }
    
        // 验证IP地址格式
        var ipPattern = /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
        if (!ipPattern.test(ip)) {
            console.log('IP地址格式验证失败');
            toastr.error('请输入有效的IPv4地址');
            return;
        }
    
        console.log('开始发送AJAX请求');
        
        // 添加调试信息，确保请求正确发送
        var requestData = {
            device_id: device_id,
            device_name: name,
            ip_address: ip
        };
        console.log('发送的数据:', JSON.stringify(requestData));
        
        // 使用fetch API替代jQuery AJAX，避免可能的兼容性问题
        fetch('/api/edge_devices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            console.log('收到响应:', response);
            if (!response.ok) {
                throw new Error('网络响应不正常');
            }
            return response.json();
        })
        .then(data => {
            console.log('解析的响应数据:', data);
            if (data.code === 200) {
                toastr.success('设备添加成功');
                // 关闭模态框
                var modalEl = document.getElementById('addDeviceModal');
                if (modalEl._bsModal) {
                    modalEl._bsModal.hide();
                } else {
                    var modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) {
                        modal.hide();
                    }
                }
                // 刷新页面
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                toastr.error(data.message || '添加失败');
            }
        })
        .catch(error => {
            console.error('请求错误:', error);
            toastr.error('添加设备失败: ' + error.message);
        });
    });
    
    // 其他代码保持不变
});
</script>
{% endblock %}
